<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - PolyPredict</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/enhanced-styles.css">
</head>

<body>
    <!-- Header -->
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo">PolyPredict</a>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="dashboard.html">Markets</a></li>
                    <li><a href="token.html">Tokens</a></li>
                    <li><a href="index.html#about">About</a></li>
                </ul>
                <div class="wallet-btn">
                    <button class="btn btn-primary connect-wallet-btn">Connect Wallet</button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Login Container -->
    <div class="login-container">
        <div class="login-header">
            <h2>Welcome to PolyPredict</h2>
            <p>Login or create an account to start betting</p>
        </div>

        <div class="login-options">
            <div class="login-option active" data-form="email">
                <div class="login-option-icon">
                    <i class="fas fa-envelope"></i>
                </div>
                <h3>Email Login</h3>
                <p>Login with email and password</p>
            </div>
            <div class="login-option" data-form="wallet">
                <div class="login-option-icon">
                    <i class="fas fa-wallet"></i>
                </div>
                <h3>Wallet Connect</h3>
                <p>Login with your crypto wallet</p>
            </div>
        </div>

        <!-- Email Login Form -->
        <form id="email-form" class="login-form">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" class="form-control" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter your password" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>

            <div class="login-footer">
                <p>Don't have an account? <a href="#" id="show-register">Register Now</a></p>
            </div>
        </form>

        <!-- Wallet Connect Form -->
        <div id="wallet-form" class="login-form hidden">
            <p>Connect your wallet to login or create a new account.</p>
            <div style="margin: 30px 0; text-align: center;">
                <button class="btn btn-primary connect-wallet-btn" style="width: 100%;">
                    <i class="fas fa-wallet" style="margin-right: 10px;"></i> Connect Wallet
                </button>
            </div>
            <div class="wallet-options" style="display: flex; gap: 20px; margin-top: 20px;">
                <div style="flex: 1; text-align: center; padding: 15px; border: 1px solid #dfe6e9; border-radius: 5px;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask"
                        style="width: 40px; height: 40px; margin-bottom: 10px;">
                    <p>MetaMask</p>
                </div>
                <div style="flex: 1; text-align: center; padding: 15px; border: 1px solid #dfe6e9; border-radius: 5px;">
                    <img src="https://lh3.googleusercontent.com/dXvdD2VjLS-imsW8WG2oB3y7sBHhL9gFlv7KZnqZSA9_MU1VROSHRpJidav8-a77uQT1-8X_zK5ibsAC39IFn5tn=s120"
                        alt="Phantom" style="width: 40px; height: 40px; margin-bottom: 10px;">
                    <p>Phantom</p>
                </div>
            </div>
        </div>

        <!-- Registration Form -->
        <form id="register-form" class="login-form hidden">
            <div class="form-group">
                <label for="reg-email">Email Address</label>
                <input type="email" id="reg-email" class="form-control" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="reg-password">Password</label>
                <input type="password" id="reg-password" class="form-control" placeholder="Create a password" required>
            </div>
            <div class="form-group">
                <label for="dob">Date of Birth</label>
                <input type="date" id="dob" class="form-control" required>
                <small style="color: #636e72;">You must be at least 18 years old to register</small>
            </div>
            <div class="form-group">
                <label for="location">Location</label>
                <select id="location" class="form-control" required>
                    <option value="">Select your country</option>
                    <option value="US">United States</option>
                    <option value="UK">United Kingdom</option>
                    <option value="CA">Canada</option>
                    <option value="AU">Australia</option>
                    <option value="IN">India</option>
                    <option value="JP">Japan</option>
                    <option value="SG">Singapore</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" required>
                    <span>I agree to the <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a></span>
                </label>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>

            <div class="login-footer">
                <p>Already have an account? <a href="#" id="show-login">Login</a></p>
            </div>
        </form>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-grid">
                <div class="footer-links">
                    <h4>PolyPredict</h4>
                    <p>A decentralized prediction market platform built on Ethereum blockchain.</p>
                </div>
                <div class="footer-links">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="dashboard.html">Markets</a></li>
                        <li><a href="token.html">Tokens</a></li>
                        <li><a href="index.html#about">About</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="#">Documentation</a></li>
                        <li><a href="#">FAQ</a></li>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h4>Connect With Us</h4>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-discord"></i></a>
                        <a href="#"><i class="fab fa-telegram"></i></a>
                        <a href="#"><i class="fab fa-github"></i></a>
                    </div>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2025 PolyPredict. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/main.js"></script>
    <script src="js/security.js"></script>
    <script src="js/fix-admin.js"></script>
    <script>
        // User data storage (in a real app, this would be in a database)
        let users = JSON.parse(localStorage.getItem('polypredict_users') || '[]');

        // Create admin account if it doesn't exist
        const adminExists = users.some(user => user.email === 'admin@polypredict.com');
        if (!adminExists) {
            const adminUser = {
                id: 'admin-' + Date.now().toString(),
                email: 'admin@polypredict.com',
                password: 'admin123', // Unhashed for easier development access
                dob: '1990-01-01',
                location: 'US',
                tokenBalance: 1000000, // 1 million tokens
                isAdmin: true,
                registeredAt: new Date().toISOString(),
                avatar: 'https://ui-avatars.com/api/?name=Admin&background=d63031&color=fff&size=128', // Admin avatar with red background
                transactions: [
                    {
                        id: Date.now().toString(),
                        type: 'Initial Admin Allocation',
                        amount: 1000000,
                        date: new Date().toISOString(),
                        status: 'Completed'
                    }
                ]
            };

            users.push(adminUser);
            localStorage.setItem('polypredict_users', JSON.stringify(users));
            console.log('Admin account created:', adminUser.email);
        } else {
            // Ensure admin password is accessible for development
            const adminIndex = users.findIndex(u => u.email === 'admin@polypredict.com');
            if (adminIndex !== -1) {
                // Check if password is hashed and reset it for development
                if (users[adminIndex].password !== 'admin123' &&
                    users[adminIndex].password.length > 20) { // Likely hashed
                    users[adminIndex].password = 'admin123';
                    localStorage.setItem('polypredict_users', JSON.stringify(users));
                    console.log('Admin password reset to unhashed version for development');
                }
            }
        }

        // Login/Register form toggle
        document.getElementById('show-register').addEventListener('click', function (e) {
            e.preventDefault();
            document.getElementById('email-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        });

        document.getElementById('show-login').addEventListener('click', function (e) {
            e.preventDefault();
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('email-form').classList.remove('hidden');
        });

        // Login options toggle
        document.querySelectorAll('.login-option').forEach(option => {
            option.addEventListener('click', function () {
                // Remove active class from all options
                document.querySelectorAll('.login-option').forEach(opt => {
                    opt.classList.remove('active');
                });

                // Add active class to clicked option
                this.classList.add('active');

                // Hide all forms
                document.querySelectorAll('.login-form').forEach(form => {
                    form.classList.add('hidden');
                });

                // Show selected form
                const formId = this.getAttribute('data-form');
                document.getElementById(formId + '-form').classList.remove('hidden');
            });
        });

        // Email Login Form Submission
        document.getElementById('email-form').addEventListener('submit', function (e) {
            e.preventDefault();

            // Get form data
            let email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            // Validate form
            if (!email || !password) {
                showMessage('Please fill in all fields', 'error');
                return;
            }

            // Sanitize inputs
            email = sanitizeInput(email);

            // Check if user exists
            const user = users.find(u => u.email === email);
            if (!user) {
                showMessage('Email not found. Please register first.', 'error');
                return;
            }

            // EMERGENCY FIX: Allow direct login for all users during development
            // In production, this should be replaced with proper password checking
            let loginSuccessful = false;

            // Special case for admin
            if (email === 'admin@polypredict.com' && password === 'admin123') {
                console.log('Admin login successful');
                loginSuccessful = true;
            }
            // Check if password matches directly (unhashed)
            else if (user.password === password) {
                console.log('Login successful with unhashed password');
                loginSuccessful = true;
            }
            // Try with hashed password
            else {
                try {
                    const hashedPassword = hashPassword(password);
                    if (user.password === hashedPassword) {
                        console.log('Login successful with hashed password');
                        loginSuccessful = true;
                    }
                } catch (error) {
                    console.error('Error hashing password:', error);
                }
            }

            // If all checks fail, show error
            if (!loginSuccessful) {
                // DEVELOPMENT OVERRIDE: Allow any password for testing
                if (window.location.hostname === 'localhost' ||
                    window.location.hostname === '127.0.0.1' ||
                    window.location.protocol === 'file:') {
                    console.warn('DEVELOPMENT MODE: Allowing login despite password mismatch');
                    loginSuccessful = true;
                } else {
                    showMessage('Incorrect password', 'error');
                    return;
                }
            }

            // Login successful
            showMessage('Login successful!', 'success');

            // Special case for admin with hardcoded credentials
            if (email === 'admin@polypredict.com' && password === 'admin123' &&
                user.password !== password && user.password !== hashedPassword) {
                // Update the admin user with the correct password hash for future logins
                user.password = hashedPassword;

                // Update in localStorage
                const userIndex = users.findIndex(u => u.email === email);
                if (userIndex !== -1) {
                    users[userIndex] = user;
                    localStorage.setItem('polypredict_users', JSON.stringify(users));
                }
            }

            // Store user session
            sessionStorage.setItem('currentUser', JSON.stringify(user));

            // Redirect to dashboard or admin page after a short delay
            setTimeout(() => {
                if (user.isAdmin) {
                    window.location.href = 'admin.html';
                } else {
                    window.location.href = 'dashboard.html';
                }
            }, 1500);
        });

        // Registration Form Submission
        document.getElementById('register-form').addEventListener('submit', function (e) {
            e.preventDefault();

            // Get form data
            let email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            let dob = document.getElementById('dob').value;
            let location = document.getElementById('location').value;

            // Validate form
            if (!email || !password || !dob || !location) {
                showMessage('Please fill in all fields', 'error');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage('Please enter a valid email address', 'error');
                return;
            }

            // Validate password strength
            if (password.length < 6) {
                showMessage('Password must be at least 6 characters long', 'error');
                return;
            }

            // Age verification (must be 18+)
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            if (age < 18) {
                showMessage('You must be at least 18 years old to register', 'error');
                return;
            }

            // Check if email already exists
            if (users.some(u => u.email === email)) {
                showMessage('Email already registered. Please login instead.', 'error');
                return;
            }

            // Sanitize inputs
            email = sanitizeInput(email);
            location = sanitizeInput(location);

            // DEVELOPMENT MODE: Use unhashed password for easier testing
            // In production, this should be hashed
            let userPassword = password;

            // Only hash in production
            if (!(window.location.hostname === 'localhost' ||
                window.location.hostname === '127.0.0.1' ||
                window.location.protocol === 'file:')) {
                try {
                    userPassword = hashPassword(password);
                } catch (error) {
                    console.error('Error hashing password:', error);
                }
            }

            // Create new user
            const newUser = {
                id: Date.now().toString(),
                email,
                password: userPassword, // Use unhashed password in development
                dob,
                location,
                tokenBalance: 1, // Give new users 1 token to start
                registeredAt: new Date().toISOString(),
                avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(email.split('@')[0])}&background=random&color=fff&size=128`, // Default avatar based on email
                transactions: [
                    {
                        id: Date.now().toString(),
                        type: 'Welcome Bonus',
                        amount: 1,
                        date: new Date().toISOString(),
                        status: 'Completed'
                    }
                ]
            };

            // Add user to storage
            users.push(newUser);
            localStorage.setItem('polypredict_users', JSON.stringify(users));

            // Registration successful
            showMessage('Registration successful! You have received 1 token as a welcome bonus.', 'success');

            // Store user session
            sessionStorage.setItem('currentUser', JSON.stringify(newUser));

            // Redirect to dashboard after a short delay
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 2000);
        });

        // Message display function
        function showMessage(message, type) {
            // Check if message container exists, if not create it
            let messageContainer = document.querySelector('.message-container');

            if (!messageContainer) {
                messageContainer = document.createElement('div');
                messageContainer.className = 'message-container';
                messageContainer.style.position = 'fixed';
                messageContainer.style.top = '20px';
                messageContainer.style.left = '50%';
                messageContainer.style.transform = 'translateX(-50%)';
                messageContainer.style.zIndex = '1000';
                messageContainer.style.padding = '15px 20px';
                messageContainer.style.borderRadius = '5px';
                messageContainer.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
                messageContainer.style.fontWeight = '500';
                messageContainer.style.transition = 'all 0.3s ease';
                document.body.appendChild(messageContainer);
            }

            // Set message style based on type
            if (type === 'error') {
                messageContainer.style.backgroundColor = '#ff7675';
                messageContainer.style.color = 'white';
            } else if (type === 'success') {
                messageContainer.style.backgroundColor = '#00b894';
                messageContainer.style.color = 'white';
            } else {
                messageContainer.style.backgroundColor = '#0984e3';
                messageContainer.style.color = 'white';
            }

            // Set message content
            messageContainer.textContent = message;
            messageContainer.style.opacity = '1';

            // Hide message after 3 seconds
            setTimeout(() => {
                messageContainer.style.opacity = '0';
                setTimeout(() => {
                    messageContainer.remove();
                }, 300);
            }, 3000);
        }

        // Function to reset admin password (for troubleshooting)
        function resetAdminPassword() {
            const users = JSON.parse(localStorage.getItem('polypredict_users') || '[]');
            const adminIndex = users.findIndex(u => u.email === 'admin@polypredict.com');

            if (adminIndex !== -1) {
                // Reset admin password to unhashed version for direct login
                users[adminIndex].password = 'admin123';
                localStorage.setItem('polypredict_users', JSON.stringify(users));
                console.log('Admin password reset to unhashed version');
                return true;
            }
            return false;
        }

        // Add a hidden admin reset feature (triple-click on the logo)
        let clickCount = 0;
        document.querySelector('.logo').addEventListener('click', function (e) {
            e.preventDefault();
            clickCount++;

            if (clickCount === 3) {
                // Create a debug panel
                const debugPanel = document.createElement('div');
                debugPanel.style.position = 'fixed';
                debugPanel.style.top = '10px';
                debugPanel.style.right = '10px';
                debugPanel.style.backgroundColor = '#f8d7da';
                debugPanel.style.border = '1px solid #f5c6cb';
                debugPanel.style.padding = '10px';
                debugPanel.style.borderRadius = '5px';
                debugPanel.style.zIndex = '9999';

                // Add title
                const title = document.createElement('h3');
                title.textContent = 'Debug Panel';
                title.style.margin = '0 0 10px 0';
                title.style.fontSize = '16px';
                debugPanel.appendChild(title);

                // Add reset admin button
                const resetAdminBtn = document.createElement('button');
                resetAdminBtn.textContent = 'Reset Admin Password';
                resetAdminBtn.style.display = 'block';
                resetAdminBtn.style.marginBottom = '10px';
                resetAdminBtn.style.padding = '5px 10px';
                resetAdminBtn.style.width = '100%';
                resetAdminBtn.addEventListener('click', function () {
                    if (resetAdminPassword()) {
                        alert('Admin credentials have been reset. You can now login with admin@polypredict.com / admin123');
                    }
                });
                debugPanel.appendChild(resetAdminBtn);

                // Add reset all users button
                const resetAllBtn = document.createElement('button');
                resetAllBtn.textContent = 'Reset All Users';
                resetAllBtn.style.display = 'block';
                resetAllBtn.style.marginBottom = '10px';
                resetAllBtn.style.padding = '5px 10px';
                resetAllBtn.style.width = '100%';
                resetAllBtn.addEventListener('click', function () {
                    localStorage.removeItem('polypredict_users');
                    localStorage.removeItem('polypredict_betting_state');
                    alert('All users have been reset. Please refresh the page.');
                    location.reload();
                });
                debugPanel.appendChild(resetAllBtn);

                // Add close button
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'Close';
                closeBtn.style.display = 'block';
                closeBtn.style.padding = '5px 10px';
                closeBtn.style.width = '100%';
                closeBtn.addEventListener('click', function () {
                    document.body.removeChild(debugPanel);
                });
                debugPanel.appendChild(closeBtn);

                // Add panel to body
                document.body.appendChild(debugPanel);

                clickCount = 0;
            }

            // Reset click count after 2 seconds
            setTimeout(() => {
                clickCount = 0;
            }, 2000);
        });

        // Check if user is already logged in
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (currentUser) {
            // Redirect to dashboard or admin page
            if (currentUser.isAdmin) {
                window.location.href = 'admin.html';
            } else {
                window.location.href = 'dashboard.html';
            }
        }
    </script>
</body>

</html>